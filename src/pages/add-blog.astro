---
import Layout from "../layouts/Layout.astro";
import Container from "../components/Container.astro";

// Check if user is authenticated and has permission
let hasPermission = false;
let isAuthenticated = false;

try {
  const cookieHeader = Astro.request.headers.get("cookie");

  const response = await fetch("http://localhost:3000/api/auth/me", {
    headers: {
      Cookie: cookieHeader || "",
    },
    credentials: "include",
  });

  if (response.ok) {
    const user = await response.json();
    isAuthenticated = true;
    hasPermission = user.permissions?.includes("blog.create");
  }
} catch (error) {
  console.error("Failed to fetch user:", error);
}

// Redirect if not authenticated or no permission
if (!isAuthenticated) {
  return Astro.redirect("/login");
}

if (!hasPermission) {
  return Astro.redirect("/");
}
---

<Layout>
  <Container>
    <div class="add-blog-container">
      <h1>Add New Blog Post</h1>

      <form id="addBlogForm">
        <div class="form-group">
          <label for="title">Title *</label>
          <input
            type="text"
            id="title"
            name="title"
            required
            placeholder="Enter blog post title"
          />
        </div>

        <div class="form-group">
          <label for="description">Description *</label>
          <textarea
            id="description"
            name="description"
            required
            maxlength="200"
            placeholder="Brief description (max 200 characters)"
            rows="3"></textarea>
          <span class="char-count">0 / 200</span>
        </div>

        <div class="form-group">
          <label for="date">Date *</label>
          <input type="date" id="date" name="date" required />
        </div>

        <div class="form-group">
          <label for="image">Image URL *</label>
          <input
            type="text"
            id="image"
            name="image"
            required
            placeholder="/images/posts/post-name.jpg"
          />
        </div>

        <div class="form-group">
          <label for="tags">Tags *</label>
          <input
            type="text"
            id="tags"
            name="tags"
            required
            placeholder="JavaScript, React, Tutorial (comma-separated)"
          />
        </div>

        <div class="form-group">
          <label for="content">Content *</label>
          <textarea
            id="content"
            name="content"
            required
            placeholder="Write your blog post content in Markdown..."
            rows="15"></textarea>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn-primary">Create Blog Post</button>
          <a href="/blog" class="btn-secondary">Cancel</a>
        </div>

        <div id="message" class="message"></div>
      </form>
    </div>
  </Container>
</Layout>

<script>
  const form = document.getElementById("addBlogForm") as HTMLFormElement;
  const messageDiv = document.getElementById("message") as HTMLDivElement;
  const descriptionTextarea = document.getElementById(
    "description",
  ) as HTMLTextAreaElement;
  const charCount = document.querySelector(".char-count") as HTMLSpanElement;
  const dateInput = document.getElementById("date") as HTMLInputElement;

  // Set today's date as default
  const today = new Date().toISOString().split("T")[0];
  dateInput.value = today;

  // Character counter
  descriptionTextarea.addEventListener("input", () => {
    const length = descriptionTextarea.value.length;
    charCount.textContent = `${length} / 200`;

    if (length > 200) {
      charCount.style.color = "red";
    } else {
      charCount.style.color = "";
    }
  });

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    messageDiv.textContent = "";
    messageDiv.className = "message";

    const formData = new FormData(form);
    const tags = (formData.get("tags") as string)
      .split(",")
      .map((tag) => tag.trim())
      .filter((tag) => tag.length > 0);

    const data = {
      title: formData.get("title"),
      description: formData.get("description"),
      date: formData.get("date"),
      image: formData.get("image"),
      tags: tags,
      content: formData.get("content"),
    };

    try {
      const response = await fetch("http://localhost:3000/api/blog/create", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(data),
        credentials: "include",
      });

      const result = await response.json();

      if (response.ok) {
        messageDiv.textContent = "âœ“ Blog post created successfully!";
        messageDiv.className = "message success";

        setTimeout(() => {
          window.location.href = "/blog";
        }, 1500);
      } else {
        messageDiv.textContent = result.error || "Failed to create blog post";
        messageDiv.className = "message error";
      }
    } catch (error) {
      messageDiv.textContent = "Network error. Please try again.";
      messageDiv.className = "message error";
      console.error("Create blog error:", error);
    }
  });
</script>

<style>
  .add-blog-container {
    padding: 60px 0;
    max-width: 800px;
    margin: 0 auto;
  }

  h1 {
    margin-bottom: 40px;
    text-align: center;
  }

  .form-group {
    margin-bottom: 24px;
    position: relative;
  }

  label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: var(--dark);
  }

  input[type="text"],
  input[type="date"],
  textarea {
    width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 16px;
    font-family: inherit;
  }

  textarea {
    resize: vertical;
  }

  input:focus,
  textarea:focus {
    outline: none;
    border-color: var(--primary);
  }

  .char-count {
    position: absolute;
    right: 8px;
    bottom: -20px;
    font-size: 12px;
    color: #666;
  }

  .form-actions {
    display: flex;
    gap: 16px;
    margin-top: 32px;
  }

  .btn-primary,
  .btn-secondary {
    padding: 14px 28px;
    border-radius: 4px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
    text-align: center;
  }

  .btn-primary {
    background: var(--primary);
    color: white;
    border: none;
    flex: 1;
  }

  .btn-primary:hover {
    opacity: 0.9;
  }

  .btn-secondary {
    background: #f5f5f5;
    color: var(--dark);
    border: 1px solid #ddd;
  }

  .btn-secondary:hover {
    background: #e5e5e5;
  }

  .message {
    margin-top: 20px;
    padding: 12px;
    border-radius: 4px;
    text-align: center;
    min-height: 20px;
  }

  .message.success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
  }

  .message.error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
  }

  @media screen and (max-width: 768px) {
    .add-blog-container {
      padding: 40px 20px;
    }

    .form-actions {
      flex-direction: column;
    }
  }
</style>
